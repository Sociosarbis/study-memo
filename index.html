<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>a house in the woods</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="a house in the woods">
<meta property="og:url" content="https://sociosarbis.github.io/study-memo/index.html">
<meta property="og:site_name" content="a house in the woods">
<meta property="og:locale" content="zh">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="a house in the woods">
  
    <link rel="alternate" href="/study-memo/atom.xml" title="a house in the woods" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/study-memo/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/study-memo/" id="logo">a house in the woods</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/study-memo/">Home</a>
        
          <a class="main-nav-link" href="/study-memo/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/study-memo/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://sociosarbis.github.io/study-memo"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-introduction-of-webpack-dll-plugin" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/study-memo/2019/03/31/introduction-of-webpack-dll-plugin/" class="article-date">
  <time datetime="2019-03-31T02:57:16.353Z" itemprop="datePublished">2019-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/study-memo/2019/03/31/introduction-of-webpack-dll-plugin/">webpack.DllPlugin简单介绍配合部分源码</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>前言</strong><br>最近深感由于公司项目过于庞大，在开发调试时，改动某处代码，常常会让 devServer 崩溃，需要重新启动打包，打包又要等待至少 5 分钟时间，严重影响开发效率这一弊病。于是乎，周末的时候看看有没有优化打包速度的方法，然后就来到这篇文章的主题了。<br><strong>正文</strong><br>所谓的 DLL 其实是一个预编译好的 JS 文件。在使用时除了打包 app 文件的 webpack config 外，需要有一个用于打包 dll 的 webpack cofig 文件。打包 dll 端需要加入 webpack.DllPlugin，app 端需要加入 webpack.DllReferencePlugin。<br>假如不加入这个 DllPlugin，就只会生成普通的打包好的 JS 文件，假如以后就会多产出一个 manifest.json 文件，表明这个 library 的包信息。<br>manifest.json 的作用在于在 app 端引入时，配合 webpack.DllReferencePlugin，生成相应的 externals 配置和把 require dll 文件里的模块的路径转成先 require dll 的父模块然后再去 require 子模块的形式。e.g.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="built_in">require</span>(<span class="string">"../dll/alpha"</span>));</span><br><span class="line"><span class="comment">// 这行app端的require语句会在webpack编译后的包中变成以下形式</span></span><br><span class="line">__webpack_require__(<span class="string">"dll-reference alpha_21c1490edb92ec8e9390"</span>)(<span class="string">"./alpha.js"</span>)</span><br><span class="line"><span class="comment">//前面的dll-reference alpha_21c1490edb92ec8e9390实际上是dll-reference前缀加上alpha_21c1490edb92ec8e9390这个包名</span></span><br><span class="line">__webpack_require__(<span class="string">"dll-reference alpha_21c1490edb92ec8e9390"</span>)</span><br><span class="line"><span class="comment">//上面的这句话实际上是下面这样返回alpha_21c1490edb92ec8e9390这个全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">module, exports</span>) </span>&#123;</span><br><span class="line"><span class="built_in">eval</span>(<span class="string">"module.exports = alpha_21c1490edb92ec8e9390;\n\n"</span>);&#125;)</span><br><span class="line"><span class="comment">//而alpha_21c1490edb92ec8e9390这个变量的定义可以简单理解为一个可以require alpha_21c1490edb92ec8e9390这个包内模块的__webpack_require__函数</span></span><br><span class="line"><span class="keyword">var</span> alpha_21c1490edb92ec8e9390 = (<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">module</span>.exports</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> __webpack_require__</span><br><span class="line">&#125;)(&#123;<span class="string">'./alpha'</span>: ..., ...&#125;)</span><br></pre></td></tr></table></figure>
<p><strong><em>通过 plugin 的配置项进行进一步的讲解</em></strong><br>这个 demo 来自于 webpack 官方的 example<br>dll 目录结构如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Downloads/dll</span><br><span class="line">│   a.js</span><br><span class="line">│   alpha.js</span><br><span class="line">│   b.js</span><br><span class="line">│   beta.js</span><br><span class="line">│   build.js</span><br><span class="line">│   c.jsx</span><br><span class="line">│   README.md</span><br><span class="line">│   template.md</span><br><span class="line">│   webpack.config.js</span><br><span class="line">│</span><br><span class="line">└───dist</span><br><span class="line">        alpha-manifest.json</span><br><span class="line">        beta-manifest.json</span><br><span class="line">        MyDll.alpha.js</span><br><span class="line">        MyDll.beta.js</span><br></pre></td></tr></table></figure>
<p>/dll/webpack.config.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">'development'</span>,</span><br><span class="line">  resolve: &#123;</span><br><span class="line">    extensions: [<span class="string">'.js'</span>, <span class="string">'.jsx'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  entry: &#123;</span><br><span class="line">    alpha: [<span class="string">'./alpha'</span>, <span class="string">'./a'</span>, <span class="string">'module'</span>],</span><br><span class="line">    beta: [<span class="string">'./beta'</span>, <span class="string">'./b'</span>, <span class="string">'./c'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.join(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'MyDll.[name].js'</span>,</span><br><span class="line">    library: <span class="string">'[name]_[hash]'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.DllPlugin(&#123;</span><br><span class="line">      path: path.join(__dirname, <span class="string">'dist'</span>, <span class="string">'[name]-manifest.json'</span>),</span><br><span class="line">      name: <span class="string">'[name]_[hash]'</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的 output.libray 和 DllPlugin 的 options.name 需要一致，假如 output.libray 为<code>&#39;[name]&#39;</code>,dll 端生成的是<code>var alpha = ...</code>而 app 端生成的是<code>module.exports = alpha_21c1490edb92ec8e9390</code>,会对应不上。<br>DllPlugin 的 options.path:manifest.json 的输出路径<br>options 里还有一个属性是 context：是一个文件路径，主要作用是 manifest.json 的 content 的 key 会转化为 js 文件路径相对于这个 context 的相对路径。<br>e.g.假如 alpha.js 的绝对路径是 C:\Users\Logicarlme\Downloads\dll\alpha.js,context 为 C:\Users\Logicarlme\Downloads\dll，那么 key 就等于’./alpha’</p>
<p><strong><em>app 端的 webpack.config.js</em></strong><br>目录结构如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Downloads/dll-user/webpack.config.js</span><br><span class="line">│   build.js</span><br><span class="line">│   example.html</span><br><span class="line">│   example.js</span><br><span class="line">│   math.js</span><br><span class="line">│   README.md</span><br><span class="line">│   template.md</span><br><span class="line">│   webpack.config.js</span><br><span class="line">│</span><br><span class="line">├───dist</span><br><span class="line">└───js</span><br><span class="line">        output.js</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /dll-user/webpack.config.js</span></span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">'development'</span>,</span><br><span class="line">  entry: path.join(__dirname, <span class="string">'example.js'</span>),</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.join(__dirname, <span class="string">'js'</span>),</span><br><span class="line">    filename: <span class="string">'output.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.DllReferencePlugin(&#123;</span><br><span class="line">      context: path.join(__dirname, <span class="string">'..'</span>, <span class="string">'dll'</span>, <span class="string">'dist'</span>),</span><br><span class="line">      manifest: <span class="built_in">require</span>(<span class="string">'../dll/dist/alpha-manifest.json'</span>) <span class="comment">// eslint-disable-line</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> webpack.DllReferencePlugin(&#123;</span><br><span class="line">      scope: <span class="string">'beta'</span>,</span><br><span class="line">      manifest: <span class="built_in">require</span>(<span class="string">'../dll/dist/beta-manifest.json'</span>), <span class="comment">// eslint-disable-line</span></span><br><span class="line">      extensions: [<span class="string">'.js'</span>, <span class="string">'.jsx'</span>]</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /dll-user/example.js</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">require</span>(<span class="string">'../dll/alpha'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">require</span>(<span class="string">'../dll/a'</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">require</span>(<span class="string">'beta/beta'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">require</span>(<span class="string">'beta/b'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">require</span>(<span class="string">'beta/c'</span>))</span><br><span class="line"><span class="comment">// 上面require的路径，一种是相对路径../dll/* 一种是scope类路径 beta/*，对于路径解析下面会有进一步的说明，需要注意的是假如是相对路径的require，那么对应的文件必须真实存在于该路径，我的理解是相对路径时，webpack会强制进行对应路径的搜索，如果文件不存在就会报错，找到以后才会把module的处理交给后面的plugins。（未经源码验证）</span></span><br></pre></td></tr></table></figure>
<p>plugins 里有两个 webpack.DllReferencePlugin，分别对应两个打包好的 dll 文件。<br>第一个 DllReferencePlugin 的 context 属性的意思是，当一个 require 解析后的 request 路径是以这个 context 开头时，那 webpack 就不会去把这个文件的内容打包进去，<br>而是把它作为 externals 处理，代理到 dll 包，从它里面去取。<br>源码部分:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">compiler.hooks.compile.tap(<span class="string">'DllReferencePlugin'</span>, params =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> name = <span class="keyword">this</span>.options.name</span><br><span class="line">  <span class="keyword">let</span> sourceType = <span class="keyword">this</span>.options.sourceType</span><br><span class="line">  <span class="keyword">let</span> content = <span class="string">'content'</span> <span class="keyword">in</span> <span class="keyword">this</span>.options ? <span class="keyword">this</span>.options.content : <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'manifest'</span> <span class="keyword">in</span> <span class="keyword">this</span>.options) &#123;</span><br><span class="line">    <span class="keyword">let</span> manifestParameter = <span class="keyword">this</span>.options.manifest</span><br><span class="line">    <span class="keyword">let</span> manifest</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> manifestParameter === <span class="string">'string'</span>) &#123;</span><br><span class="line">      <span class="comment">// If there was an error parsing the manifest</span></span><br><span class="line">      <span class="comment">// file, exit now because the error will be added</span></span><br><span class="line">      <span class="comment">// as a compilation error in the "compilation" hook.</span></span><br><span class="line">      <span class="keyword">if</span> (params[<span class="string">'dll reference parse error '</span> + manifestParameter]) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      manifest =</span><br><span class="line">        <span class="comment">/** @type &#123;DllReferencePluginOptionsManifest&#125; */</span> (params[</span><br><span class="line">          <span class="string">'dll reference '</span> + manifestParameter</span><br><span class="line">        ])</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      manifest = manifestParameter</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (manifest) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!name) name = manifest.name</span><br><span class="line">      <span class="keyword">if</span> (!sourceType) sourceType = manifest.type</span><br><span class="line">      <span class="keyword">if</span> (!content) content = manifest.content</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> externals = &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> source = <span class="string">'dll-reference '</span> + name</span><br><span class="line">  externals[source] = name</span><br><span class="line">  <span class="keyword">const</span> normalModuleFactory = params.normalModuleFactory</span><br><span class="line">  <span class="keyword">new</span> ExternalModuleFactoryPlugin(sourceType || <span class="string">'var'</span>, externals).apply(</span><br><span class="line">    normalModuleFactory</span><br><span class="line">  ) <span class="comment">/* 这里把"dll-reference " + name作为externals的字段，</span></span><br><span class="line"><span class="comment">      对应上面说的dll-reference alpha_21c1490edb92ec8e9390，</span></span><br><span class="line"><span class="comment">      而externals的variable的变量名就是包名alpha_21c1490edb92ec8e9390，</span></span><br><span class="line"><span class="comment">      对应上面提到的module.exports = alpha_21c1490edb92ec8e9390</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">new</span> DelegatedModuleFactoryPlugin(&#123;</span><br><span class="line">    source: source,</span><br><span class="line">    type: <span class="keyword">this</span>.options.type,</span><br><span class="line">    scope: <span class="keyword">this</span>.options.scope,</span><br><span class="line">    context: <span class="keyword">this</span>.options.context || compiler.options.context,</span><br><span class="line">    content,</span><br><span class="line">    extensions: <span class="keyword">this</span>.options.extensions</span><br><span class="line">  &#125;).apply(normalModuleFactory)</span><br><span class="line">  <span class="comment">/* 这里的DelegatedModuleFactoryPlugin的作用实际上是把提到的console.log(require("../dll/alpha"));的require</span></span><br><span class="line"><span class="comment">    变成__webpack_require__("dll-reference alpha_21c1490edb92ec8e9390")("./alpha.js")，</span></span><br><span class="line"><span class="comment">    也就是说代理到dll-reference alpha_21c1490edb92ec8e9390上</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面是DelegatedModuleFactoryPlugin的执行流程</span></span><br><span class="line">apply(normalModuleFactory) &#123;</span><br><span class="line">  <span class="keyword">const</span> scope = <span class="keyword">this</span>.options.scope;</span><br><span class="line">  <span class="keyword">if</span> (scope) &#123; <span class="comment">//这里可以看一下上面beta.dll的scope</span></span><br><span class="line">    normalModuleFactory.hooks.factory.tap(</span><br><span class="line">      <span class="string">"DelegatedModuleFactoryPlugin"</span>,</span><br><span class="line">      factory =&gt; <span class="function">(<span class="params">data, callback</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> dependency = data.dependencies[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">const</span> request = dependency.request;</span><br><span class="line">        <span class="keyword">if</span> (request &amp;&amp; request.indexOf(scope + <span class="string">"/"</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">//可以看出它会先把scope去掉，让"." + 剩下的部分作为实际的require请求</span></span><br><span class="line">          <span class="keyword">const</span> innerRequest = <span class="string">"."</span> + request.substr(scope.length);</span><br><span class="line">          <span class="keyword">let</span> resolved;</span><br><span class="line">          <span class="keyword">if</span> (innerRequest <span class="keyword">in</span> <span class="keyword">this</span>.options.content) &#123;</span><br><span class="line">            <span class="comment">//会在manifest.json的content中找 实际的require请求 的对应字段</span></span><br><span class="line">            resolved = <span class="keyword">this</span>.options.content[innerRequest];</span><br><span class="line">            <span class="keyword">return</span> callback(</span><br><span class="line">              <span class="literal">null</span>,</span><br><span class="line">              <span class="keyword">new</span> DelegatedModule(</span><br><span class="line">                <span class="keyword">this</span>.options.source,</span><br><span class="line">                resolved,</span><br><span class="line">                <span class="keyword">this</span>.options.type,</span><br><span class="line">                innerRequest,</span><br><span class="line">                request</span><br><span class="line">              )</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.options.extensions.length; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> extension = <span class="keyword">this</span>.options.extensions[i];</span><br><span class="line">            <span class="keyword">const</span> requestPlusExt = innerRequest + extension;</span><br><span class="line">            <span class="keyword">if</span> (requestPlusExt <span class="keyword">in</span> <span class="keyword">this</span>.options.content) &#123;</span><br><span class="line">              resolved = <span class="keyword">this</span>.options.content[requestPlusExt];</span><br><span class="line">              <span class="keyword">return</span> callback(</span><br><span class="line">                <span class="literal">null</span>,</span><br><span class="line">                <span class="keyword">new</span> DelegatedModule(</span><br><span class="line">                  <span class="keyword">this</span>.options.source,</span><br><span class="line">                  resolved,</span><br><span class="line">                  <span class="keyword">this</span>.options.type,</span><br><span class="line">                  requestPlusExt,</span><br><span class="line">                  request + extension</span><br><span class="line">                )</span><br><span class="line">              );</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> factory(data, callback);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    normalModuleFactory.hooks.module.tap(</span><br><span class="line">      <span class="string">"DelegatedModuleFactoryPlugin"</span>,</span><br><span class="line">      <span class="built_in">module</span> =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">module</span>.libIdent) &#123;</span><br><span class="line">          <span class="comment">// 这里其实跟上面去除scope的作用是类似的，把前面的context去掉，留下实际的request</span></span><br><span class="line">          <span class="keyword">const</span> request = <span class="built_in">module</span>.libIdent(<span class="keyword">this</span>.options);</span><br><span class="line">          <span class="keyword">if</span> (request &amp;&amp; request <span class="keyword">in</span> <span class="keyword">this</span>.options.content) &#123;</span><br><span class="line">            <span class="keyword">const</span> resolved = <span class="keyword">this</span>.options.content[request];</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DelegatedModule(</span><br><span class="line">              <span class="keyword">this</span>.options.source,</span><br><span class="line">              resolved,</span><br><span class="line">              <span class="keyword">this</span>.options.type,</span><br><span class="line">              request,</span><br><span class="line">              <span class="built_in">module</span></span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">module</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//无论是否使用scope最后生成的都是一个DelegatedModule</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//DelegatedModule的source方法可以印证上面DelegatedModuleFactoryPlugin的作用，以demo为例</span></span><br><span class="line">source(depTemplates, runtime) &#123;</span><br><span class="line">    <span class="keyword">const</span> dep = <span class="comment">/** @type &#123;DelegatedSourceDependency&#125; */</span> (<span class="keyword">this</span>.dependencies[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">const</span> sourceModule = dep.module;</span><br><span class="line">    <span class="keyword">let</span> str;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!sourceModule) &#123;</span><br><span class="line">      str = WebpackMissingModule.moduleCode(<span class="keyword">this</span>.sourceRequest);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      str = <span class="string">`module.exports = (<span class="subst">$&#123;runtime.moduleExports(&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">        <span class="built_in">module</span>: sourceModule,</span></span></span><br><span class="line"><span class="string"><span class="subst">        request: dep.request</span></span></span><br><span class="line"><span class="string"><span class="subst">            &#125;</span>)&#125;)`</span>;<span class="comment">//这一部分对应webpack/lib/RuntimeTemplate.js的moduleExports方法，</span></span><br><span class="line">            <span class="comment">//生成module.exports = __webpack_require__("dll-reference alpha_21c1490edb92ec8e9390")部分</span></span><br><span class="line">      <span class="keyword">switch</span> (<span class="keyword">this</span>.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"require"</span>:</span><br><span class="line">          str += <span class="string">`(<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(<span class="keyword">this</span>.request)&#125;</span>)`</span>; <span class="comment">//这里再在str后加上("./alpha.js")</span></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"object"</span>:</span><br><span class="line">          str += <span class="string">`[<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(<span class="keyword">this</span>.request)&#125;</span>]`</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      str += <span class="string">";"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>ExternalModule</em></strong><br>说了 dll,其实也要顺带说一下 ExternalModule 的原理。概括来说就是把 require 模块的内容不直接写到 bundle 中，而是把他的引用作为 module 的 exports<br>具体可以看下下面的源码：<br>lib/ExternalModule.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//external模块为global变量</span></span><br><span class="line">getSourceForGlobalVariableExternal(variableName, type) &#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(variableName)) &#123;</span><br><span class="line">		<span class="comment">// make it an array as the look up works the same basically</span></span><br><span class="line">		variableName = [variableName];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// needed for e.g. window["some"]["thing"]</span></span><br><span class="line">	<span class="keyword">const</span> objectLookup = variableName</span><br><span class="line">		.map(<span class="function"><span class="params">r</span> =&gt;</span> <span class="string">`[<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(r)&#125;</span>]`</span>)</span><br><span class="line">		.join(<span class="string">""</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="string">`(function() &#123; module.exports = <span class="subst">$&#123;type&#125;</span><span class="subst">$&#123;objectLookup&#125;</span>; &#125;());`</span>;</span><br><span class="line">&#125;</span><br><span class="line">   <span class="comment">//external模块为commonjs模块</span></span><br><span class="line">getSourceForCommonJsExternal(moduleAndSpecifiers) &#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(moduleAndSpecifiers)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">`module.exports = require(<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(</span></span></span><br><span class="line"><span class="string"><span class="subst">			moduleAndSpecifiers</span></span></span><br><span class="line"><span class="string"><span class="subst">		)&#125;</span>);`</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> moduleName = moduleAndSpecifiers[<span class="number">0</span>];</span><br><span class="line">	<span class="keyword">const</span> objectLookup = moduleAndSpecifiers</span><br><span class="line">		.slice(<span class="number">1</span>)</span><br><span class="line">		.map(<span class="function"><span class="params">r</span> =&gt;</span> <span class="string">`[<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(r)&#125;</span>]`</span>)</span><br><span class="line">           .join(<span class="string">""</span>);</span><br><span class="line">       <span class="comment">//e.g. 输出格式require("some")["thing"]</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">`module.exports = require(<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(</span></span></span><br><span class="line"><span class="string"><span class="subst">		moduleName</span></span></span><br><span class="line"><span class="string"><span class="subst">	)&#125;</span>)<span class="subst">$&#123;objectLookup&#125;</span>;`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//external模块为amd或umd模块</span></span><br><span class="line">getSourceForAmdOrUmdExternal(id, optional, request) &#123;</span><br><span class="line">	<span class="keyword">const</span> externalVariable = <span class="string">`__WEBPACK_EXTERNAL_MODULE_<span class="subst">$&#123;Template.toIdentifier(</span></span></span><br><span class="line"><span class="string"><span class="subst">		<span class="string">`<span class="subst">$&#123;id&#125;</span>`</span></span></span></span><br><span class="line"><span class="string"><span class="subst">	)&#125;</span>__`</span>;</span><br><span class="line">	<span class="keyword">const</span> missingModuleError = optional</span><br><span class="line">		? <span class="keyword">this</span>.checkExternalVariable(externalVariable, request)</span><br><span class="line">		: <span class="string">""</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;missingModuleError&#125;</span>module.exports = <span class="subst">$&#123;externalVariable&#125;</span>;`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//external模块为一个普通的全局变量</span></span><br><span class="line">getSourceForDefaultCase(optional, request) &#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(request)) &#123;</span><br><span class="line">		<span class="comment">// make it an array as the look up works the same basically</span></span><br><span class="line">		request = [request];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> variableName = request[<span class="number">0</span>];</span><br><span class="line">	<span class="keyword">const</span> missingModuleError = optional</span><br><span class="line">		? <span class="keyword">this</span>.checkExternalVariable(variableName, request.join(<span class="string">"."</span>))</span><br><span class="line">		: <span class="string">""</span>;</span><br><span class="line">	<span class="keyword">const</span> objectLookup = request</span><br><span class="line">		.slice(<span class="number">1</span>)</span><br><span class="line">		.map(<span class="function"><span class="params">r</span> =&gt;</span> <span class="string">`[<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(r)&#125;</span>]`</span>)</span><br><span class="line">           .join(<span class="string">""</span>);</span><br><span class="line">       <span class="comment">//e.g.输出格式module.exports = some["thing"];</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;missingModuleError&#125;</span>module.exports = <span class="subst">$&#123;variableName&#125;</span><span class="subst">$&#123;objectLookup&#125;</span>;`</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>说一下 webpack.config.externals 的配置项,下面是官方示例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  externals: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// String</span></span><br><span class="line">      react: <span class="string">'react'</span>,</span><br><span class="line">      <span class="comment">// Object</span></span><br><span class="line">      lodash: &#123;</span><br><span class="line">        commonjs: <span class="string">'lodash'</span>,</span><br><span class="line">        amd: <span class="string">'lodash'</span>,</span><br><span class="line">        root: <span class="string">'_'</span> <span class="comment">// indicates global variable</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// Array</span></span><br><span class="line">      subtract: [<span class="string">'./math'</span>, <span class="string">'subtract'</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// Function</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">context, request, callback</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="regexp">/^yourregex$/</span>.test(request)) &#123;</span><br><span class="line">        <span class="keyword">return</span> callback(<span class="literal">null</span>, <span class="string">'commonjs '</span> + request)</span><br><span class="line">      &#125;</span><br><span class="line">      callback()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// Regex</span></span><br><span class="line">    /^(jquery|\$)$/i</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之前我一直都不明白这些配置是怎么用的，尤其是以 function 使用时，callback 的第一个参数用的是 null，这到底指代什么。还有 umd，cmd，root 这些，他们是什么情况夏才会起效的。带着上面这些疑问，我阅读了下源码:lib/ExternalModuleFactoryPlugin.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> handleExternal = <span class="function">(<span class="params">value, type, callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> type === <span class="string">"function"</span>) &#123;</span><br><span class="line">        callback = type;</span><br><span class="line">        type = <span class="literal">undefined</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (value === <span class="literal">false</span>) <span class="keyword">return</span> factory(data, callback);</span><br><span class="line">    <span class="keyword">if</span> (value === <span class="literal">true</span>) value = dependency.request;</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="literal">undefined</span> &amp;&amp; <span class="regexp">/^[a-z0-9]+ /</span>.test(value)) &#123;</span><br><span class="line">        <span class="keyword">const</span> idx = value.indexOf(<span class="string">" "</span>);</span><br><span class="line">        type = value.substr(<span class="number">0</span>, idx);</span><br><span class="line">        value = value.substr(idx + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    callback(</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        <span class="keyword">new</span> ExternalModule(value, type || globalType, dependency.request)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> externals === <span class="string">"string"</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (externals === dependency.request) &#123;</span><br><span class="line">        <span class="keyword">return</span> handleExternal(dependency.request, callback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(externals)) &#123;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> next = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> asyncFlag;</span><br><span class="line">        <span class="keyword">const</span> handleExternalsAndCallback = <span class="function">(<span class="params">err, <span class="built_in">module</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">module</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (asyncFlag) &#123;</span><br><span class="line">                    asyncFlag = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> next();</span><br><span class="line">            &#125;</span><br><span class="line">            callback(<span class="literal">null</span>, <span class="built_in">module</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            asyncFlag = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (i &gt;= externals.length) <span class="keyword">return</span> callback();</span><br><span class="line">            handleExternals(externals[i++], handleExternalsAndCallback);</span><br><span class="line">        &#125; <span class="keyword">while</span> (!asyncFlag);</span><br><span class="line">        asyncFlag = <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    next();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (externals <span class="keyword">instanceof</span> <span class="built_in">RegExp</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (externals.test(dependency.request)) &#123;</span><br><span class="line">        <span class="keyword">return</span> handleExternal(dependency.request, callback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> externals === <span class="string">"function"</span>) &#123;</span><br><span class="line">    externals.call(</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        context,</span><br><span class="line">        dependency.request,</span><br><span class="line">        (err, value, type) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);</span><br><span class="line">            <span class="keyword">if</span> (value !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                handleExternal(value, type, callback);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                callback();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> externals === <span class="string">"object"</span> &amp;&amp;</span><br><span class="line">    <span class="built_in">Object</span>.prototype.hasOwnProperty.call(externals, dependency.request)</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">return</span> handleExternal(externals[dependency.request], callback);</span><br><span class="line">&#125;</span><br><span class="line">callback();</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>上面的各个条件语句分别对应 externals 里各种形式的配置。<br>分别举例 1.<code>externals: &#39;react&#39;</code> 会转成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">callback(<span class="literal">null</span>, <span class="keyword">new</span> ExternalModule(<span class="string">'react'</span>, <span class="literal">undefined</span> || globalType, <span class="string">'react'</span>))</span><br></pre></td></tr></table></figure>
<p>tips：from lib/WebpackOptionsApply.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (options.externals) &#123;</span><br><span class="line">  ExternalsPlugin = <span class="built_in">require</span>(<span class="string">'./ExternalsPlugin'</span>)</span><br><span class="line">  <span class="keyword">new</span> ExternalsPlugin(</span><br><span class="line">    options.output.libraryTarget,</span><br><span class="line">    <span class="comment">//当设置了externals后，会添加一个ExternalsPlugin，而它的type默认为output.libraryTarget, 而libraryTarget默认为'var',这里是一个伏笔，后面会提到</span></span><br><span class="line">    options.externals</span><br><span class="line">  ).apply(compiler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.<code>externals: [&#39;react&#39;, &#39;jquery&#39;]</code> 只不过是单个 externals 推广为多个，把里面的每一个配置按除 2 以外的规则进行处理,数组里面可以是 string, regExp 和 Object 3.<code>externals: /^(jquery|\$)$/i</code> 当 require 的 request 符合正则的形式时，会把这个 request 与 1 一样处理</p>
<p>4.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">externals: <span class="function"><span class="keyword">function</span>(<span class="params">context, request, callback</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="regexp">/^yourregex$/</span>.test(request)) &#123;</span><br><span class="line">        <span class="keyword">return</span> callback(<span class="literal">null</span>, <span class="string">'commonjs '</span> + request)</span><br><span class="line">      &#125;</span><br><span class="line">      callback()</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<p>如果是 function 时就直接执行这个 function，而 callback 参数为</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">;<span class="function">(<span class="params">err, value, type</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err)</span><br><span class="line">  <span class="keyword">if</span> (value !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    handleExternal(value, type, callback)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    callback()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里可以回答上面的问题，callback 的第一个参数 null 到底指的是什么，指的是否出现 err。<br>第二个参数’commonjs ‘ + request，为包导出方式 + 空格 + 模块名的形式，它会在 handleExternal 中以第一个空格分成两个字符串，字符串 1 表示 ExternalModule 的导出形式，字符串 2 为模块名 5.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">externals: &#123;</span><br><span class="line">      <span class="comment">// String</span></span><br><span class="line">      react: <span class="string">'react'</span>,</span><br><span class="line">      <span class="comment">// Object</span></span><br><span class="line">      lodash: &#123;</span><br><span class="line">        commonjs: <span class="string">'lodash'</span>,</span><br><span class="line">        amd: <span class="string">'lodash'</span>,</span><br><span class="line">        root: <span class="string">'_'</span> <span class="comment">// indicates global variable</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// Array</span></span><br><span class="line">      subtract: [<span class="string">'./math'</span>, <span class="string">'subtract'</span>]</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<p>上面 Object 的情况有三种形式：<br><strong>第一种 value 是 string，实际上是 value 是 Object 的特殊情况。表示不论是以 commonjs, amd, root 等哪种方式导出，他的变量名都是 react</strong><br><strong>第二种 value 是 Object, 表示根据导出的方式，返回对应的变量名</strong><br>e.g. commonjs 时是 module.exports = require(‘loadsh’) root 时是 module.exports = _<br>那这个导出方式是以什么决定的呢？如果是普通的 externals,那么就跟 1 中的 tips 代码注释写的一样，跟打包时 output.libraryTarget 一致的。如果是 dll 的情况就取<br>DllReferencePlugin 的 options.sourceType 或者 manifest.json 的 type 字段，如果都没有默认就是 var。这里就是 1 中的 tips 里说的伏笔，因为我之前没有在官方的例子中，找到有用过 var 字段的，以为默认是 root 或者 global 因为一般只看到 externals 中用到这两种表示全局的。但事实上他们不是划为同一种进行处理的，<br>看一下源码:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lib/ExternalModule.js</span></span><br><span class="line"><span class="keyword">switch</span> (<span class="keyword">this</span>.externalType) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"this"</span>:</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"window"</span>:</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"self"</span>:</span><br><span class="line">				...</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"global"</span>:</span><br><span class="line">				...</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"commonjs"</span>:</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"commonjs2"</span>:</span><br><span class="line">				...</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"amd"</span>:</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"amd-require"</span>:</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"umd"</span>:</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"umd2"</span>:</span><br><span class="line">        ...</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				...</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>并且在分情况返回变量名的处理方法是<code>this.request[this.externalType]</code>，也就是说以’var’和上面的 lodash 为例子的话，那就相当于({commonjs: ‘lodash’,amd:’lodash’,root: ‘_‘ })[‘var’]。那这样的话自然在编译时就变成了<code>module.exports=undefined</code><br><strong>_第三种 value 是 Array，它的处理方式以当包导出方式是以 var 为例说明,根据上面的 switch condition 可知当为 var 时，按 defaultCase 处理</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">getSourceForDefaultCase(optional, request) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//request参数代入我们的['./math', 'subtract']，可得最后return的值为module.exports = ./math["subtract"]，可以看出数组的第一个参数是作为模块名或者变量名，后面的参数作为对象的属性，一层层获取的。然后就是var的情况./math["subtract"]，显然是不合法的。如果是commonjs的话，就是require('./math')["subtract"],这个代入getSourceForCommonJsExternal可以知道。</span></span><br><span class="line">    <span class="keyword">const</span> variableName = request[<span class="number">0</span>];</span><br><span class="line">		<span class="keyword">const</span> objectLookup = request</span><br><span class="line">			.slice(<span class="number">1</span>)</span><br><span class="line">			.map(<span class="function"><span class="params">r</span> =&gt;</span> <span class="string">`[<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(r)&#125;</span>]`</span>)</span><br><span class="line">            .join(<span class="string">""</span>);</span><br><span class="line">        <span class="comment">//e.g.输出格式module.exports = some["thing"];</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;missingModuleError&#125;</span>module.exports = <span class="subst">$&#123;variableName&#125;</span><span class="subst">$&#123;objectLookup&#125;</span>;`</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>##总结###<br>上面的解析写的比较乱，而且有很多文章内的引用，下次可以考虑使用锚点进行页内跳转。<br>dll 的工作流程大概是，通过 DllPlugin 打包 library 获得 js 和 manifest 文件，使用时通过 DllReferencePlugin 读取 manifest 文件，解析 dll 中包含的子模块名等信息。<br>DllReferencePlugin 内部，创建 ExternalModule，把 dll 加入到 externals 中，然后通过 DelegatedModule，把对实际文件的 require 请求，代理到 dll 包中。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sociosarbis.github.io/study-memo/2019/03/31/introduction-of-webpack-dll-plugin/" data-id="cjtx7ypkr000v5gu10v3neu9v" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/dll/">dll</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/externals/">externals</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/webpack/">webpack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-compile_cpp_from_command_line" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/study-memo/2019/03/10/compile_cpp_from_command_line/" class="article-date">
  <time datetime="2019-03-10T11:43:30.615Z" itemprop="datePublished">2019-03-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/study-memo/2019/03/10/compile_cpp_from_command_line/">使用命令行编译C++</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近这几个月都有在看C++的知识，由于之前一直都在用VSCode写代码，所以也想在编写C++代码时也尽量不需要换IDE。但是本身VSCode在辅助编译上没有等提供UI的支持，所以需要知道一些原始的命令行编译方面的配置。<br>VSCode的改作C++IDE，可以按照这个网页的说明进行配置[VSCode的C++配置]<a href="https://www.zhihu.com/question/30315894/answer/154979413" target="_blank" rel="noopener">https://www.zhihu.com/question/30315894/answer/154979413</a><br>1.上面的配置适用于单文件的无第三方库的编译，从里面的参数来看， 命令行只需要<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang++ <span class="variable">$fileName</span> -o <span class="variable">$fileNameWithoutExt</span>.exe就可以生成可执行文件</span><br></pre></td></tr></table></figure></p>
<p>2.如果需要编译多个.cpp文件则需要,注意头文件不能放在命令行中直接引入<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang++ <span class="variable">$fileName1</span> <span class="variable">$fileName2</span> ...(表示省略第二文件以后的文件名) -o <span class="variable">$fileNameWithoutExt</span>.exe</span><br></pre></td></tr></table></figure></p>
<p>3.如果我在文件中用了第三方库e.g.Boost的话,下面是Boost的入门demo<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/lambda/lambda.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iterator&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> boost::lambda;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="built_in">std</span>::istream_iterator&lt;<span class="keyword">int</span>&gt; in;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::for_each(</span><br><span class="line">        in(<span class="built_in">std</span>::<span class="built_in">cin</span>), in(), <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; (_1 * <span class="number">3</span>) &lt;&lt; <span class="string">" "</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果我们直接进行编译，编译器会显示<strong>fatal error: ‘boost/lambda/lambda.hpp’ file not found</strong>错误，说编译器找不到头文件，如果是我们编写的头文件在include的时候会使用double quote（双引），编译器默认会在文件的当前目录下进行查找这个头文件。但是如果是尖括号的&lt;<strong>boost/lambda/lambda.hpp</strong>&gt;,则需要把库文件的目录加入到命令行中，供编译器进行查找。则需要用到-I&lt;dir&gt;参数，如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang++ -I <span class="string">"C:/Program Files/boost_1_69_0"</span> <span class="variable">$fileName</span> -o <span class="variable">$fileNameWithoutExt</span>.exe</span><br></pre></td></tr></table></figure></p>
<p>4.虽然上面这个简单的用例可以不报错了，但是对于以下这个例子不适用<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/array.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/asio.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> boost::asio::ip::tcp;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"Usage: client &lt;host&gt;"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        boost::asio::io_context io_context;</span><br><span class="line"></span><br><span class="line">        tcp::<span class="function">resolver <span class="title">resolver</span><span class="params">(io_context)</span></span>;</span><br><span class="line">        tcp::resolver::results_type endpoints = resolver.resolve(argv[<span class="number">1</span>], <span class="string">"daytime"</span>);</span><br><span class="line">        tcp::<span class="function">socket <span class="title">socket</span><span class="params">(io_context)</span></span>;</span><br><span class="line">        boost::asio::connect(socket, endpoints);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;)</span><br><span class="line">        &#123;</span><br><span class="line">            boost::<span class="built_in">array</span>&lt;<span class="keyword">char</span>, 128&gt; buf;</span><br><span class="line">            boost::system::error_code error;</span><br><span class="line">            <span class="keyword">size_t</span> len = socket.read_some(boost::asio::buffer(buf), error);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (error == boost::asio::error::eof)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (error)</span><br><span class="line">                <span class="keyword">throw</span> boost::system::system_error(error);</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span>.write(buf.data(), len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (<span class="built_in">std</span>::exception&amp; e)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; e.what() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为boost::asio会需要用到windows的动态库wsock32等，直接编译会报<code>undefined reference to `__imp_WSAStartup&#39;</code>等错误，<br>这时候需要加上-lwsock32 -lWs2_32这个option<strong>（-l指定某个文件）</strong>，导入wsock32和Ws2_32这两个dll才能成功编译。其实dll也有类似头文件的搜索路径，<br>windows默认在C:\Windows\System32，如果要添加搜索路径可以通过-L&lt;dir&gt;添加。</p>
<p>在写这篇记录的时候知道两个小知识，第一个是如果cpp中用到了标准库，则需要指定–target=x86_64-w64-mingw这个option，默认在windows的target是x86_64-pc-windows-msvc，由于本机没有安装visual studio，如果不改target的话会找不到头文件。<br>另外获取编译时编译器查找library的search path的方法为在编译的命令行语句后加上-v这个flag</p>
<p><strong><em>待续</em></strong><br>总结有些仓促，如果有新的发现，会进行更新。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sociosarbis.github.io/study-memo/2019/03/10/compile_cpp_from_command_line/" data-id="cjtx7ypjp00035gu1wefgzhzl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/C/">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/CLI/">CLI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/Clang/">Clang++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/windows/">windows</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-use-temporary-variables-in-Vue-template" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/study-memo/2019/01/12/use-temporary-variables-in-Vue-template/" class="article-date">
  <time datetime="2019-01-12T13:32:53.990Z" itemprop="datePublished">2019-01-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/study-memo/2019/01/12/use-temporary-variables-in-Vue-template/">在Vue的template里面使用临时变量</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>前言</strong><br>实际上很久以前就发现了这样的问题了，在 vue 的 template 中不能使用临时变量，而使用 render 函数就不存在这样的问题了。这周五因为在重构项目里某个方法，而在 UI 方面使用的是 vue，里面就有需要使用临时变量的情况。<br>某个部分的 template 大概是这样的</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"hasNextParams"</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-for</span>=<span class="string">"getNextParams"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>他用到的两个方法其实逻辑是差不多的，实际上可以都用 getNextParams 的结果作为 v-if 的判断。但问题是由于需要在两个地方需要引用到这个临时的结果，导致没修改前需要重复调用一个方法，正常来说，我们应该只做一次运算，缓存这个结果就好了。于是，我下班后就查了一下，在 stackOverflow 里找到了 scope-slot 的方案。（其实这个假如是熟悉 vue 的同学应该一下就想出来了，惭愧）<br>这个方案结合我自己的实际情况，修改后做了一个这样的组件，代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">slot</span> <span class="attr">v-bind</span>=<span class="string">"passedProps"</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">    name: <span class="string">'Pass'</span>,</span></span><br><span class="line"><span class="undefined">    props: &#123;</span></span><br><span class="line"><span class="javascript">      passedProps: <span class="built_in">Object</span>,</span></span><br><span class="line"><span class="javascript">      <span class="keyword">default</span>() &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> &#123;&#125;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--组件调用--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Pass</span> <span class="attr">style</span>=<span class="string">"color:#c00;"</span> <span class="attr">:passedProps</span>=<span class="string">"&#123;params: [1, 2, 3]&#125;"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--这里的slot-scope拿到的是上面bind到slot上的值，这里还用了解构取到里面的params参数--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">template</span> <span class="attr">slot-scope</span>=<span class="string">"&#123;params&#125;"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"params.length &gt;= 0"</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123; params &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Pass</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>后记</strong><br>在我实践过程中发现实际上<code>&lt;template&gt;&lt;div/&gt;&lt;/template&gt;</code>组件跟React里面<code>{[&lt;div/&gt;]}</code>代表的意思是一样的，他返回的是一个数组，实际他不是一个根，由于是一个数组，会报错跟你说需要提供一个单根而不能是multi-root，所以也就能理解为什么Vue文件里的template下不能直接加template标签作为他的根了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sociosarbis.github.io/study-memo/2019/01/12/use-temporary-variables-in-Vue-template/" data-id="cjtx7ypjs00055gu1utqhc187" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/template/">template</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/temporary-variable/">temporary variable</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/vue/">vue</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Needleman-Wunsch-Algorithm" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/study-memo/2018/12/09/Needleman-Wunsch-Algorithm/" class="article-date">
  <time datetime="2018-12-09T13:54:50.103Z" itemprop="datePublished">2018-12-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/study-memo/2018/12/09/Needleman-Wunsch-Algorithm/">学习Needleman-Wunsch-algorithm</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>_前言_</strong><br>最近一段时间，有位同事被分配开发一个基于对象树的类 git 的功能。其中需要做对象列表的插入删除的 diff 实现，在她分享中她提到是通过改编过的 Needleman-Wunsch 算法实现的，能够返回插入或删除的具体对象。感觉这个算法是挺有用的，于是乎这个周末就找资料了解了一下。<br><strong><em>具体算法说明</em></strong><br>一开始这个算法是为了比较两个蛋白质的氨基酸序列的相似性而提出的。后来也推广应用到文本比对。<br>具体来讲，设我们有两个字符串。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="string">'nowyouseeme'</span></span><br><span class="line"><span class="keyword">const</span> b = <span class="string">'cuzletitbe'</span></span><br><span class="line"><span class="keyword">const</span> lenA = a.length</span><br><span class="line"><span class="keyword">const</span> lenB = b.length</span><br></pre></td></tr></table></figure>
<p>1.首先需要构造一个(lenA + 1) * (lenB + 1)大小的矩阵</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> matrix = <span class="built_in">Array</span>.from(&#123;</span><br><span class="line">  length: lenB + <span class="number">1</span></span><br><span class="line">&#125;).map(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Array</span>(lenA + <span class="number">1</span>).fill(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p>2.给第一行和第一列设置初始值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> i</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; lenB + <span class="number">1</span>; i++) &#123;</span><br><span class="line">  matrix[i][<span class="number">0</span>] = <span class="number">-1</span> * i</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> j</span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; lenA + <span class="number">1</span>; j++) &#123;</span><br><span class="line">  matrix[<span class="number">0</span>][j] = <span class="number">-1</span> * j</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>一开始我就有一个疑问，为什么初始值是-1 * 序号呢？-1 是什么含义？</strong><br>其实这里的-1 表示的是当前格的分数是从左一格或者从上一格的求出的时候的得分。<br>然后这里就要说明一下这个矩阵的格子除了初始的行列以外其余格的数值是怎么算出来的了。<br>这些格子的取是左上格，上格，左格这三个前面的格子的值分别加上当前格得分后的最大值。<br>当前格的得分定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> match = <span class="number">1</span> <span class="comment">// 当前行对应的字符等于当前列对应的字符时的得分，这个值只能与左上格数值相加</span></span><br><span class="line"><span class="keyword">let</span> dismatch = <span class="number">-3</span> <span class="comment">// 当前行对应的字符不等于当前列对应的字符时的得分， 这个值只能与左上格数值相加</span></span><br><span class="line"><span class="keyword">let</span> gap = <span class="number">-1</span> <span class="comment">// 不管相等还是不相等，默认都加在上格或者左格进行最大值判定</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">例如比较上面两个字符串的第一个字符</span></span><br><span class="line"><span class="comment">|   |   | n |</span></span><br><span class="line"><span class="comment">-------------</span></span><br><span class="line"><span class="comment">|   | 0 |-1 |</span></span><br><span class="line"><span class="comment">-------------</span></span><br><span class="line"><span class="comment">| c |-1 |-1 |</span></span><br><span class="line"><span class="comment">因为第一个字符不相等所以 </span></span><br><span class="line"><span class="comment">matrix[1][1] = Math.max(matrix[0][0] - 3, matrix[0][1] -1, matrix[1][0] -1) // 1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>计算格子值代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; lenB + <span class="number">1</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; lenA + <span class="number">1</span>; j++) &#123;</span><br><span class="line">    <span class="keyword">const</span> scoreFromTopLeft = a[j - <span class="number">1</span>] === b[i - <span class="number">1</span>] ? match : dismatch</span><br><span class="line">    matrix[i][j] = <span class="built_in">Math</span>.max(</span><br><span class="line">      matrix[i - <span class="number">1</span>][j - <span class="number">1</span>] + scoreFromTopLeft,</span><br><span class="line">      matrix[i - <span class="number">1</span>][j] + gap,</span><br><span class="line">      matrix[i][j - <span class="number">1</span>] - gap</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">//下面这个链接的会把这个最大值是取自哪个这个信息给存到traceback_type_status这个二维数组里面</span></span><br><span class="line">    <span class="comment">//方便回溯的时候知道上一步来自哪个方向,当然也可以不存，在回溯的时候再判断</span></span><br><span class="line">    <span class="comment">// const intermediate_scores = [matrix[i - 1][j - 1] + scoreFromTopLeft, matrix[i - 1][j] + gap,matrix[i][j - 1] - gap]</span></span><br><span class="line">    <span class="comment">// const tracebackTypeStatus = intermediate_scores.map((e, i) =&gt; e === score);</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得分计算有人做了一个动态计算表格生动展示了其机制，地址:[needle-wunsch]<a href="https://blievrouw.github.io/needleman-wunsch/" target="_blank" rel="noopener">https://blievrouw.github.io/needleman-wunsch/</a></p>
<p><strong>回溯的方法：</strong><br>1.像上面提到的，根据当前格子的值是取自哪里来确定回溯方向的<br>2.上面这个在线 demo 他取目标字符串为列， 原字符串为行，删除添加字符操作的记录方法为：<br><strong>如果是添加（值取自左格）</strong>，给原字符串的 alignment 添加’-‘字符，目标字符串的 alignment 添加目标字符串的对应字符<br><strong>如果是删除（值取自上格）</strong>，给目标字符串的 alignment 添加’-‘字符，原字符串的 alignment 添加原字符串的对应字符<br><strong>如果是一致或者不一致（值取自左上格）</strong>，则同时添加对应字符 3.重复 1，2 的步骤没有可回溯的方向<br>但是上面这个方法，稍稍一想可能会注意到，假如是 dismatch（不一致）的情况，那么按照上面的方法就不会添加’-‘字符表示操作了，<br>当然也可以在这种情况下默认是添加新字符，删除旧字符两个操作，但是这样就比较生硬。所以为了排除当 dismatch 时，会取左上格的情况，<br><strong>我们需要让 dismatch 的 penalty 小于 gap_penalty * 2，这样最大值就不会取自左上了。</strong></p>
<p>最后要提一点的是demo里的回溯代码，他没有用递归实现，而是<strong>把下一步要进入的路径，保存到上一条路径的next里</strong>，当上一条路径走完，<br>会把next变成current，因为这个我不会太会用这种方法，同时这种方法效率也会比较高，所以觉得比较有趣就提一下吧。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (current) &#123;</span><br><span class="line">  pos = current.pos</span><br><span class="line">  alignment = current.alignment</span><br><span class="line">  <span class="comment">// Get children alignments</span></span><br><span class="line">  children = <span class="keyword">this</span>.alignmentChildren(current.pos)</span><br><span class="line">  <span class="comment">// Store completed alignments</span></span><br><span class="line">  <span class="keyword">if</span> (!children.length) &#123;</span><br><span class="line">    final_alignments.push(alignment)</span><br><span class="line">  &#125;</span><br><span class="line">  current = current.next</span><br><span class="line">  <span class="keyword">for</span> (t = <span class="number">0</span>, len = children.length; t &lt; len; t++) &#123;</span><br><span class="line">    child = children[t]</span><br><span class="line">    child.alignment = &#123;</span><br><span class="line">      seq1: alignment.seq1.concat(</span><br><span class="line">        child.tracebackType === <span class="number">0</span> ? <span class="string">'-'</span> : <span class="keyword">this</span>.seq1[pos[<span class="number">0</span>] - <span class="number">1</span>]</span><br><span class="line">      ), <span class="comment">// -1 refers to offset between  scoring matrix and the sequence</span></span><br><span class="line">      seq2: alignment.seq2.concat(</span><br><span class="line">        child.tracebackType === <span class="number">2</span> ? <span class="string">'-'</span> : <span class="keyword">this</span>.seq2[pos[<span class="number">1</span>] - <span class="number">1</span>]</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Move down a layer</span></span><br><span class="line">    child.next = current</span><br><span class="line">    current = child</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sociosarbis.github.io/study-memo/2018/12/09/Needleman-Wunsch-Algorithm/" data-id="cjtx7ypja00005gu11k3sw4rc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/Needleman-Wunsch/">Needleman-Wunsch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/algorithm/">algorithm</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-simple-implementation-of-observer-to-illustrate-how-vue-watcher-works" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/study-memo/2018/11/11/simple-implementation-of-observer-to-illustrate-how-vue-watcher-works/" class="article-date">
  <time datetime="2018-11-11T08:39:51.585Z" itemprop="datePublished">2018-11-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/study-memo/2018/11/11/simple-implementation-of-observer-to-illustrate-how-vue-watcher-works/">通过简化版的Observer的实现来说明vue的watch的工作原理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong><em>前言</em></strong><br>其实关于vue实例watch项的设置是怎么观测到数据变化的，这个问题很久之前我就很有兴趣去了解了。之前也有通过一些文章去了解过，由于懒，了解完以后就自己亲自做深入的探索或者说自己去阅读源码，所以很长的一段时间来说，我对这个机制还是有点模糊的。但是，这周周五，工作上碰到了一个问题——怎么脱离vue（或者说不去创建vue的实例设置watch项）然后去检测vuex store的变化呢。<br>其实这个问题最简单的，后来发现原来vuex有一个api是Vuex.store.watch能够直接监听state的变化(<a href="https://vuex.vuejs.org/api/#watch" target="_blank" rel="noopener">说明地址:https://vuex.vuejs.org/api/#watch</a>),但是怎么能因为有现成的api而放弃这样一个看源码了解其中原理的机会呢，于是，有了下面这一段简化版的源码以及用例<br><strong><em>简化版源码</em></strong><br>其实下面的代码来自几个文件，这里为了阅读清晰就把他们放在一起了。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> Dep = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> uid = <span class="number">0</span></span><br><span class="line">      <span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">          <span class="keyword">constructor</span>() &#123;</span><br><span class="line">              <span class="keyword">this</span>.id = uid++</span><br><span class="line">              <span class="keyword">this</span>.subs = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line">          &#125;</span><br><span class="line">          depend() &#123;</span><br><span class="line">              <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">                  Dep.target.addDep(<span class="keyword">this</span>)</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          removeSub(sub) &#123;</span><br><span class="line">              <span class="keyword">this</span>.subs.delete(sub)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          addSub(sub) &#123;</span><br><span class="line">              <span class="keyword">this</span>.subs.add(sub)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          notify() &#123;</span><br><span class="line">              <span class="keyword">this</span>.subs.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">sub</span>) </span>&#123;</span><br><span class="line">                  sub.update()</span><br><span class="line">              &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      Dep.target = <span class="literal">null</span></span><br><span class="line">      <span class="keyword">return</span> Dep</span><br><span class="line">  &#125;</span><br><span class="line">  )()</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">parsePath</span>(<span class="params">exp</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> path = exp.split(<span class="string">'.'</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">vm</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> path.reduce(<span class="function"><span class="keyword">function</span>(<span class="params">result, property</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">return</span> result[property]</span><br><span class="line">          &#125;, vm)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> Watcher = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> uid = <span class="number">0</span></span><br><span class="line">      <span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">          <span class="keyword">constructor</span>(vm, expOrFn, cb) &#123;</span><br><span class="line">              <span class="keyword">this</span>.id = uid++</span><br><span class="line">              <span class="keyword">this</span>.vm = vm</span><br><span class="line">              <span class="keyword">this</span>.cb = cb</span><br><span class="line">              <span class="keyword">this</span>.newDeps = <span class="keyword">new</span> <span class="built_in">Map</span>()</span><br><span class="line">              <span class="keyword">this</span>.deps = <span class="keyword">new</span> <span class="built_in">Map</span>()</span><br><span class="line">              <span class="keyword">this</span>.getter = parsePath(expOrFn)</span><br><span class="line">              <span class="keyword">this</span>.value = <span class="keyword">this</span>.get()</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          get() &#123;</span><br><span class="line">              Dep.target = <span class="keyword">this</span></span><br><span class="line">              <span class="keyword">let</span> value</span><br><span class="line">              <span class="keyword">const</span> vm = <span class="keyword">this</span>.vm</span><br><span class="line">              value = <span class="keyword">this</span>.getter.call(vm, vm)</span><br><span class="line">              Dep.target = <span class="literal">null</span></span><br><span class="line">              <span class="keyword">this</span>.cleanupDeps()</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          addDep(dep) &#123;</span><br><span class="line">              <span class="built_in">console</span>.log(<span class="keyword">this</span>.newDeps)</span><br><span class="line">              <span class="keyword">const</span> id = dep.id</span><br><span class="line">              <span class="keyword">if</span> (!<span class="keyword">this</span>.newDeps.has(id)) &#123;</span><br><span class="line">                  <span class="keyword">this</span>.newDeps.set(id, dep)</span><br><span class="line">                  <span class="keyword">if</span> (!<span class="keyword">this</span>.deps.has(id)) &#123;</span><br><span class="line">                      dep.addSub(<span class="keyword">this</span>)</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          cleanupDeps() &#123;</span><br><span class="line">              <span class="keyword">this</span>.deps.forEach(<span class="function">(<span class="params">dep</span>)=&gt;</span>&#123;</span><br><span class="line">                  <span class="keyword">if</span> (!<span class="keyword">this</span>.newDeps.has(dep.id)) &#123;</span><br><span class="line">                      dep.removeSub(<span class="keyword">this</span>)</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              );</span><br><span class="line">              <span class="keyword">let</span> nextDeps = <span class="keyword">this</span>.newDeps</span><br><span class="line">              <span class="keyword">this</span>.newDeps = <span class="keyword">this</span>.deps</span><br><span class="line">              <span class="keyword">this</span>.deps = nextDeps</span><br><span class="line">              <span class="keyword">this</span>.newDeps.clear()</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          update() &#123;</span><br><span class="line">              <span class="keyword">const</span> oldValue = <span class="keyword">this</span>.value</span><br><span class="line">              <span class="keyword">this</span>.value = <span class="keyword">this</span>.get()</span><br><span class="line">              <span class="keyword">this</span>.cb.call(<span class="keyword">this</span>.vm, <span class="keyword">this</span>.value, oldValue)</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> Watcher</span><br><span class="line">  &#125;</span><br><span class="line">  )()</span><br><span class="line">  <span class="keyword">const</span> Observer = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> arrayProto = <span class="built_in">Array</span>.prototype</span><br><span class="line">      <span class="keyword">const</span> methodToPatch = [<span class="string">'push'</span>, <span class="string">'pop'</span>, <span class="string">'splice'</span>, <span class="string">'shift'</span>, <span class="string">'unshift'</span>]</span><br><span class="line">      <span class="keyword">const</span> arrayMethods = <span class="built_in">Object</span>.create(arrayProto)</span><br><span class="line">      methodToPatch.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">method</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">const</span> original = arrayProto[method]</span><br><span class="line">          <span class="built_in">Object</span>.defineProperty(arrayMethods, method, &#123;</span><br><span class="line">              value: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                  <span class="keyword">const</span> result = original.apply(<span class="keyword">this</span>, args)</span><br><span class="line">                  <span class="keyword">const</span> ob = <span class="keyword">this</span>.__ob__</span><br><span class="line">                  <span class="keyword">let</span> inserted</span><br><span class="line">                  <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">                  <span class="keyword">case</span> <span class="string">'push'</span>:</span><br><span class="line">                  <span class="keyword">case</span> <span class="string">'unshift'</span>:</span><br><span class="line">                      inserted = args</span><br><span class="line">                      <span class="keyword">break</span></span><br><span class="line">                  <span class="keyword">case</span> <span class="string">'splice'</span>:</span><br><span class="line">                      inserted = args.slice(<span class="number">2</span>)</span><br><span class="line">                      <span class="keyword">break</span></span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">if</span> (inserted)</span><br><span class="line">                      ob.observeArray(inserted)</span><br><span class="line">                  ob.dep.notify()</span><br><span class="line">                  <span class="keyword">return</span> result</span><br><span class="line">              &#125;,</span><br><span class="line">              enumerable: <span class="literal">false</span></span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> value !== <span class="string">'object'</span>)</span><br><span class="line">              <span class="keyword">return</span></span><br><span class="line">          <span class="keyword">let</span> ob</span><br><span class="line">          <span class="keyword">if</span> (value.hasOwnProperty(<span class="string">'__ob__'</span>)) &#123;</span><br><span class="line">              ob = value.__ob__</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              ob = <span class="keyword">new</span> Observer(value)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> ob</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">          <span class="keyword">constructor</span>(value) &#123;</span><br><span class="line">              <span class="keyword">this</span>.value = value</span><br><span class="line">              <span class="keyword">this</span>.dep = <span class="keyword">new</span> Dep()</span><br><span class="line">              <span class="built_in">Object</span>.defineProperty(value, <span class="string">'__ob__'</span>, &#123;</span><br><span class="line">                  value: <span class="keyword">this</span>,</span><br><span class="line">                  enumerable: <span class="literal">false</span></span><br><span class="line">              &#125;)</span><br><span class="line">              <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">                  copyAugment(value, arrayMethods, methodToPatch)</span><br><span class="line">                  <span class="keyword">this</span>.observeArray(value)</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">this</span>.walk(value)</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          walk(obj) &#123;</span><br><span class="line">              <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(obj)</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">                  defineReactive(obj, keys[i])</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          observeArray(items) &#123;</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = items.length; i &lt; l; i++) &#123;</span><br><span class="line">                  observe(items)</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">copyAugment</span>(<span class="params">target, src, keys</span>) </span>&#123;</span><br><span class="line">          keys.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">              <span class="built_in">Object</span>.defineProperty(target, key, &#123;</span><br><span class="line">                  value: src[k],</span><br><span class="line">                  enumerable: <span class="literal">false</span></span><br><span class="line">              &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">const</span> dep = <span class="keyword">new</span> Dep()</span><br><span class="line">          <span class="keyword">const</span> property = <span class="built_in">Object</span>.getOwnPropertyDescriptor(obj, key)</span><br><span class="line">          <span class="keyword">if</span> (property) &#123;</span><br><span class="line">              <span class="keyword">const</span> &#123;getter, setter&#125; = property</span><br><span class="line">              <span class="keyword">let</span> val</span><br><span class="line">              <span class="keyword">if</span> (!getter || setter) &#123;</span><br><span class="line">                  val = obj[key]</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">let</span> childOb = observe(val)</span><br><span class="line">              <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">                  get: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                      <span class="keyword">const</span> value = getter ? getter.call(obj) : val</span><br><span class="line">                      <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">                          dep.depend()</span><br><span class="line">                          <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">                              childOb.dep.depend()</span><br><span class="line">                              <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">                                  dependArray(value)</span><br><span class="line">                              &#125;</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">return</span> value</span><br><span class="line">                  &#125;,</span><br><span class="line">                  set: <span class="function"><span class="keyword">function</span>(<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">                      <span class="keyword">const</span> value = getter ? getter.call(obj) : val</span><br><span class="line">                      <span class="keyword">if</span> (value === newVal) &#123;</span><br><span class="line">                          <span class="keyword">return</span></span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">if</span> (getter &amp;&amp; !setter)</span><br><span class="line">                          <span class="keyword">return</span></span><br><span class="line">                      <span class="keyword">if</span> (setter) &#123;</span><br><span class="line">                          setter.call(obj, newVal)</span><br><span class="line">                      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                          val = newVal</span><br><span class="line">                      &#125;</span><br><span class="line">                      childOb = observe(newVal)</span><br><span class="line">                      dep.notify()</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">dependArray</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">let</span> e, i = <span class="number">0</span>, l = value.length; i &lt; l; i++) &#123;</span><br><span class="line">              e = value[i]</span><br><span class="line">              e &amp;&amp; e.__ob__ &amp;&amp; e.__ob__.dep.depend()</span><br><span class="line">              <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(e)) &#123;</span><br><span class="line">                  dependArray(e)</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> Observer</span><br><span class="line">  &#125;</span><br><span class="line">  )()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> a = &#123;</span><br><span class="line">      b: <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">new</span> Observer(a)</span><br><span class="line">  <span class="built_in">console</span>.log(a)</span><br><span class="line">  <span class="keyword">new</span> Watcher(a,<span class="string">'b'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'观测到更新'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">new</span> Watcher(a,<span class="string">'b'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'我也观测到更新'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  )</span><br><span class="line">  a.b = <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line">)()</span><br></pre></td></tr></table></figure></p>
<p><strong><em>机制总结</em></strong><br>上面的代码可以简单地总结为，为obj创建一个Observer，对他的每个属性都去添加getter/setter，setter是为了知道属性被设置的这一信息，同时当被设置的属性为Object的时候重新observe这个value，这样reactive的机制才不会断。<br>一般来说以前我一般只会用到setter这一点，而不会去使用getter，因为好像getter只是获取这个值而已，而跟观测数据变化没有什么关系的样子。但是在这里的作用是，当设置了property的getter，然后watcher创建时，获取property的值时，getter就会执行，由于此时Dep这个class的target属性被设置为当前的这个watcher，所以getter就有机会在执行的时候把这个watcher作为自己的订阅者（当setter执行时，一一去notify自己的订阅者，通知数据变化）<br>watcher里自身也会去维护自己的publisher（订阅的对象），应该是为了当自己不再watch的时候，能够让publisher取消通知自己，所以说是publisher维护subscriber,subscriber维护自己的publisher，一个双向的维护（也是值得一提的点）<br>当observe的对象是数组时，数组首层element的变化会通过Observer的dep去发布，这一点与Object的情况略有不同。<br>而通过重写数组操作的一些prototype上的方法，而监听数据变化的做法，也是比较好理解的，这里就不赘述了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sociosarbis.github.io/study-memo/2018/11/11/simple-implementation-of-observer-to-illustrate-how-vue-watcher-works/" data-id="cjtx7ypkb000r5gu169763ykn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/vue/">vue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/watcher/">watcher</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ast-exploration" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/study-memo/2018/10/20/ast-exploration/" class="article-date">
  <time datetime="2018-10-20T08:19:32.639Z" itemprop="datePublished">2018-10-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/study-memo/2018/10/20/ast-exploration/">探索抽象语法树</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>源起:</strong><br>前段时间通过一篇关于开发者他介绍自己开发的 web 应用的文章知道了这名开发者。觉得他很厉害，要向他学习。所以呢，就学习一下他之前做过的项目。虽然是想认真研究完的，一来是代码没有什么注释，二来我认真看过的部分某些其实可参考意义不是很大。所以这个计划的执行就暂停了。不过呢，在其中我也找到了一个我想了解的方向，就是 AST（抽象语法树），这个其实会挺有用的。<br>原因我暂时想到的有两点:<br>一、通过解析代码，能够拿到代码结构化的信息，这样可以应用于一些代码自动化生成，解析模块依赖等（这种可以自动化的东西就是我辈所向往的）<br>二、单纯自己通过正则去实现这样的解析还是一个比较麻烦的工程，暂时非自己能力所及。<br><strong>实践:</strong><br>JS 的 AST 的解析主要会用到 Babel 这个库。其中需要了解到的主要有这三个个包@babel/parser(babylon)、@babel/traverse、@babel/type。<br>下面以官方的一个插件说明 AST 中的一些概念和使用流程:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 以下为babel-plugin-transform-remove-console的部分源码</span></span><br><span class="line"><span class="comment">    插件export的是一个接收当前babel对象的函数，这里他取这个对象的types属性，这个types属性出自于@babel/types，</span></span><br><span class="line"><span class="comment">    在这里用于创建AST节点替换原来的节点。</span></span><br><span class="line"><span class="comment">    函数返回一个对象，对象比较重要的属性是visitor。用来定义当遍历访问到某类节点时，需要进行的用户自定义的操作。</span></span><br><span class="line"><span class="comment">    节点的类型可以很简单地在AST Explorer中书写代码，通过显示的解析后的AST树中获知。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">&#123; types: t &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    name: <span class="string">"transform-remove-console"</span>,</span><br><span class="line">    visitor: &#123;</span><br><span class="line">      <span class="comment">// CallExpression表示函数调用，这些vistor的函数接收两个参数第一个是NodePath的对象</span></span><br><span class="line">      <span class="comment">// 另一个是用于缓存遍历数据的参数state</span></span><br><span class="line">      <span class="comment">// 便于用户在访问节点时存储自己需要的信息</span></span><br><span class="line">      CallExpression(path, state) &#123;</span><br><span class="line">        <span class="keyword">const</span> callee = path.get(<span class="string">"callee"</span>);</span><br><span class="line">        <span class="comment">// NodePath通过get方法，获得对应的子Path，注意返回的也是一个NodePath的对象，并非是节点本身</span></span><br><span class="line">        <span class="comment">// Node可以通过NodePath.node获取，NodePath除了存储当前的Node以外,还保存节点的层级结构</span></span><br><span class="line">        <span class="comment">// 如通过Path.getSibling(index) 获取nth的当前层级的NodePath;</span></span><br><span class="line">        <span class="comment">// path.parentPath 获父NodePath</span></span><br><span class="line">        <span class="comment">// 另外所有替换删除的操作都是在NodePath上进行</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// NodePath有一系列is开头的方法，用于确认Path是否为某种类型</span></span><br><span class="line">        <span class="keyword">if</span> (!callee.isMemberExpression()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isIncludedConsole(callee, state.opts.exclude)) &#123;</span><br><span class="line">          <span class="comment">// console.log()</span></span><br><span class="line">          <span class="keyword">if</span> (path.parentPath.isExpressionStatement()) &#123;</span><br><span class="line">            path.remove(); <span class="comment">// 删除Path</span></span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            path.replaceWith(createVoid0());</span><br><span class="line">            <span class="comment">// 用一个新的NodePath代替原来的NodePath</span></span><br><span class="line">            <span class="comment">// NodePath一般用上面的types参数以types.UnaryExpression等</span></span><br><span class="line">            <span class="comment">// types后接NodePath type的构造方法创建</span></span><br><span class="line">            <span class="comment">// 如这里的createVoid0就是以types.UnaryExpression('void', [0])构造的</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isIncludedConsoleBind(callee, state.opts.exclude)) &#123;</span><br><span class="line">          <span class="comment">// console.log.bind()</span></span><br><span class="line">          path.replaceWith(createNoop());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      MemberExpression: &#123;</span><br><span class="line">        <span class="comment">// 访问节点有两个阶段一个是enter、一个exit，默认是enter</span></span><br><span class="line">        <span class="comment">// 访问结束发生该节点下的子节点遍历完返回时</span></span><br><span class="line">        exit(path, state) &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            isIncludedConsole(path, state.opts.exclude) &amp;&amp;</span><br><span class="line">            !path.parentPath.isMemberExpression()</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">              path.parentPath.isAssignmentExpression() &amp;&amp;</span><br><span class="line">              path.parentKey === <span class="string">"left"</span></span><br><span class="line">            ) &#123;</span><br><span class="line">              path.parentPath.get(<span class="string">"right"</span>).replaceWith(createNoop());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              path.replaceWith(createNoop());</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 值得一提的是在这个插件加了一个验证console是否为全局的操作</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">isGlobalConsoleId</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> name = <span class="string">"console"</span>;</span><br><span class="line">    <span class="comment">// 首先通过scope.getBinding确认console是否是为用户定义的，其次再验证在全局作用域中是否有console定义</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      id.isIdentifier(&#123; name &#125;) &amp;&amp;</span><br><span class="line">      !id.scope.getBinding(name) &amp;&amp;</span><br><span class="line">      id.scope.hasGlobal(name)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//ps: 一个小的发现在visitor函数中this等于参数state</span></span><br></pre></td></tr></table></figure>
<p><strong>结语：</strong><br>我这里写的只是 AST 的冰山一粒，上述内容其实在 babel handbook 上都有，把自己心得体会记录下来，一是要是以后忘记了，看自己的文字更加容易唤醒自己的记忆，二是为自己的学习留下痕迹，再者有新的发现再到新文章中再叙吧。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sociosarbis.github.io/study-memo/2018/10/20/ast-exploration/" data-id="cjtx7ypjk00015gu1sc6asyyc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/AST/">AST</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-maintain-the-same-hexo-project-with-diffrent-devices" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/study-memo/2018/10/11/maintain-the-same-hexo-project-with-diffrent-devices/" class="article-date">
  <time datetime="2018-10-11T15:18:34.252Z" itemprop="datePublished">2018-10-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/study-memo/2018/10/11/maintain-the-same-hexo-project-with-diffrent-devices/">使用不用终端维护同一个hexo博客</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="初步不合理的尝试"><a href="#初步不合理的尝试" class="headerlink" title="初步不合理的尝试"></a>初步不合理的尝试</h3><p>这个问题来自于今天在公司我尝试使用 hexo 去生成个人博客，hexo 的 deploy 只会生成页面 build 好的文件并推送到远程仓库，<br>这样远程仓库就没有 hexo 项目的 source 了。因此，回家以后就没有项目的文件进行下一步的维护。只好重新创建一次项目，并推送<br>远程仓库分支上，这样不同在不同终端上都能获取到这些文件了。<br>于是我凭着直觉和对 git 微薄的认知，进行了一下两次不同的错误尝试。</p>
<h3 id="尝试一："><a href="#尝试一：" class="headerlink" title="尝试一："></a>尝试一：</h3><p><strong>1.</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@github.com:Sociosarbis/study-memo.git</span><br></pre></td></tr></table></figure>
<p><strong>2.</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b hexo</span><br></pre></td></tr></table></figure>
<p><strong>3.</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo init</span><br></pre></td></tr></table></figure>
<p>初始化 hexo 项目，然后问题来了，hexo 提示需要当前文件夹是一个空文件夹，只能把所有文件夹的都删，包括.git 文件夹。<br>这样一来就相当于重头来过</p>
<h4 id="尝试二"><a href="#尝试二" class="headerlink" title="尝试二:"></a>尝试二:</h4><p><strong>1.</strong> 既然需要一个空文件夹，那么就从刚才的空文件夹开始</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo init</span><br></pre></td></tr></table></figure>
<p><strong>2.</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b hexo</span><br></pre></td></tr></table></figure>
<p><strong>3.</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin git@github.com:Sociosarbis/study-memo.git</span><br></pre></td></tr></table></figure>
<p>自觉这一步是会关联所有的本地分支和远程分支的，<br><strong><em>但其实只是相当于给仓库地址创建了一个 shortname，例如上面的 origin 代表了 <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>:Sociosarbis/study-memo.git 的地址</em></strong></p>
<p><strong>4.</strong> 直接<code>git push origin/hexo</code>然后提示远程并没有这个仓库</p>
<p><strong>5.</strong> 好吧，既然这样就手动在 github 上创建 hexo 的分支，但是这个分支完完全全是 master 的复制<br><strong>6.</strong> 创建完以后再尝试 push，然后提示需要 pull 一次<br><strong>7.</strong> 然后直接<code>git pull</code>，错误提示没有指定需要从哪个远程分支 pull</p>
<p><strong>8.</strong> 那我就用这个命令把两个分支关联起来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch --<span class="built_in">set</span>-upstream-to=origin/hexo hexo</span><br></pre></td></tr></table></figure>
<p>然后再<code>git pull</code>一次再次错误提示<code>refusing to merge unrelated histories</code></p>
<p><strong>9.</strong> 网上 search 过后在<code>git pull</code>后面加上<code>--allow-unrelated-histories</code>，终于 pull 成功了</p>
<p><strong>10.</strong> 接下来就是我比较熟悉的过程了，删除 pull 下来的生成的页面文件，commit 以后再 push 上去，成功解决</p>
<h3 id="正确做法"><a href="#正确做法" class="headerlink" title="正确做法"></a>正确做法</h3><p>虽然最后成功完成了任务，但是这样明显是不够优雅的。<br>再去网上查找，找到了两个能很好地解决这次问题的或者说关于本地与远程仓库关联的两个命令。</p>
<p><strong>分别是</strong>:</p>
<p><strong>1.</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push --<span class="built_in">set</span>-upstream origin branch_name</span><br></pre></td></tr></table></figure>
<p>在远程创建一个与本地 branch_name 分支同名的分支并跟踪</p>
<p><strong>2.</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout --track orgin/branch_name</span><br></pre></td></tr></table></figure>
<p>在本地创建一个与 branch_name 同名分支跟踪远程分支</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sociosarbis.github.io/study-memo/2018/10/11/maintain-the-same-hexo-project-with-diffrent-devices/" data-id="cjtx7ypjr00045gu1dgctazlt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/study-memo/tags/git/">git</a></li></ul>

    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/study-memo/tags/AST/">AST</a></li><li class="tag-list-item"><a class="tag-list-link" href="/study-memo/tags/C/">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/study-memo/tags/CLI/">CLI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/study-memo/tags/Clang/">Clang++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/study-memo/tags/Needleman-Wunsch/">Needleman-Wunsch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/study-memo/tags/algorithm/">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/study-memo/tags/dll/">dll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/study-memo/tags/externals/">externals</a></li><li class="tag-list-item"><a class="tag-list-link" href="/study-memo/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/study-memo/tags/template/">template</a></li><li class="tag-list-item"><a class="tag-list-link" href="/study-memo/tags/temporary-variable/">temporary variable</a></li><li class="tag-list-item"><a class="tag-list-link" href="/study-memo/tags/vue/">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/study-memo/tags/watcher/">watcher</a></li><li class="tag-list-item"><a class="tag-list-link" href="/study-memo/tags/webpack/">webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/study-memo/tags/windows/">windows</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/study-memo/tags/AST/" style="font-size: 10px;">AST</a> <a href="/study-memo/tags/C/" style="font-size: 10px;">C++</a> <a href="/study-memo/tags/CLI/" style="font-size: 10px;">CLI</a> <a href="/study-memo/tags/Clang/" style="font-size: 10px;">Clang++</a> <a href="/study-memo/tags/Needleman-Wunsch/" style="font-size: 10px;">Needleman-Wunsch</a> <a href="/study-memo/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/study-memo/tags/dll/" style="font-size: 10px;">dll</a> <a href="/study-memo/tags/externals/" style="font-size: 10px;">externals</a> <a href="/study-memo/tags/git/" style="font-size: 10px;">git</a> <a href="/study-memo/tags/template/" style="font-size: 10px;">template</a> <a href="/study-memo/tags/temporary-variable/" style="font-size: 10px;">temporary variable</a> <a href="/study-memo/tags/vue/" style="font-size: 20px;">vue</a> <a href="/study-memo/tags/watcher/" style="font-size: 10px;">watcher</a> <a href="/study-memo/tags/webpack/" style="font-size: 10px;">webpack</a> <a href="/study-memo/tags/windows/" style="font-size: 10px;">windows</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/study-memo/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/study-memo/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/study-memo/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/study-memo/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/study-memo/archives/2018/10/">October 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/study-memo/2019/03/31/introduction-of-webpack-dll-plugin/">webpack.DllPlugin简单介绍配合部分源码</a>
          </li>
        
          <li>
            <a href="/study-memo/2019/03/10/compile_cpp_from_command_line/">使用命令行编译C++</a>
          </li>
        
          <li>
            <a href="/study-memo/2019/01/12/use-temporary-variables-in-Vue-template/">在Vue的template里面使用临时变量</a>
          </li>
        
          <li>
            <a href="/study-memo/2018/12/09/Needleman-Wunsch-Algorithm/">学习Needleman-Wunsch-algorithm</a>
          </li>
        
          <li>
            <a href="/study-memo/2018/11/11/simple-implementation-of-observer-to-illustrate-how-vue-watcher-works/">通过简化版的Observer的实现来说明vue的watch的工作原理</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Sociosarbis<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/study-memo/" class="mobile-nav-link">Home</a>
  
    <a href="/study-memo/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/study-memo/fancybox/jquery.fancybox.css">
  <script src="/study-memo/fancybox/jquery.fancybox.pack.js"></script>


<script src="/study-memo/js/script.js"></script>



  </div>
</body>
</html>